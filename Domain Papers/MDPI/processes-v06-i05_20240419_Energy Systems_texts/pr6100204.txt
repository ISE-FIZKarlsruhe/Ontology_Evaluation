In the context of an increasing participation of renewable energy in the electricity market, demand response is a strategy promoted by electricity companies to balance the non-programmable supply of electricity with its usage. Through the use of differential electricity prices, a switch in energy consumption patterns is stimulated. In recent years, energy self-storage in batteries has been proposed as a way to take advantage of differential prices without a major disruption in daily routines. Although a promising solution, charge and discharge cycles also degrade batteries, thus expected savings in the energy bill may actually be non-existent if these savings are counterbalanced by the capacity lost by the battery. In this work a convex optimization problem that finds the operating schedule for a battery and includes the effects of current-induced degradation is presented. The goal is to have a tool that facilitates for a consumer the evaluation of the convenience of installing a battery-based energy storage system under different but given assumptions of electricity and battery prices. The problem is solved assuming operation of a commercial Li-ion under two very different yet representative electricity pricing policies.
Connecting renewable energy sources to the electric grid changes the classical paradigm: as these sources are non-programmable an imbalance between electricity generation and electricity consumption is created. As electricity as such cannot be stored, two main strategies have been proposed to overcome the imbalance: conversion of electricity to a type of energy that can be stored and demand response [
1
,
2
]. In the former, energy storage, the amount of electricity that is produced in excess at a certain time is centrally converted to for example potential energy (through mechanical pumping) or chemical-electrochemical energy (e.g., production of 




H


2




 or large-scale batteries). Then, when needed at a later time, this energy is reconverted to electricity and discharged to the grid. In the latter, demand response, a change in electricity consumption habits to match the production rate is sought. This change in habits is promoted by adjusting the price of electricity at different times: when there is an expected large demand or low production of electricity, its price increases, and the opposite when demand is low and supply is large. The term tariff policy or pricing policy refers to the electricity price schedule that companies develop to stimulate demand response. In this context, many energy markets have developed different tariff policies [
3
,
4
]. Broadly speaking, tariff policies can be classified as pre-established and on-spot. On on-spot tariffs, electricity prices and even allowed amounts of energy that might be purchased, are announced publicly shortly before the expected consumption (from minutes, up to one day ahead). On pre-established tariffs, electricity prices are known to consumers, but might be different for weekdays and weekends/holidays, and, within each day, they might change hourly. These types of tariffs are also known as time of use pricing (TOU).
Implementation of these policies have given the consumers the opportunity of reducing the total cost of the electricity they use, by increasing their energy consumption when electricity price is low and reducing the consumption when the price is high. Still, not all uses can be managed this way. In particular, in the residential sector, major savings imply a large reorganization of daily routines, which is only worth if there is a strong penalization in the hours that energy consumption is to be reduced. For residents or small-scale businesses, self-storage represents a more suitable non-routine disruptive way to achieve savings in electricity costs. For these purposes, electrochemical, thermal, and even an increase in inventory when the price is low, have been pointed out as valid self-storage alternatives [
5
].
Along these lines, how to optimally store energy to maximize savings is a problem currently being addressed in the literature, a complete review can be found in Weitzel and Glock [
6
]. With the foreseen decline in the costs of batteries [
7
,
8
] incorporation of this kind of energy storage solution may soon be economically viable for all sectors, including small enterprises and households. This economic viability will depend on both the savings due to TOU and battery lifespan and replacement cost.
Battery lifespan and replacement cost depend on its degradation rate, which in turn depend on how much and how the battery is used. The relevance of including these factors when formulating problems to find an optimal battery operation policy has been recognized in Reniers et al. [
9
]. Battery degradation mechanisms depend on many factors, in particular, the rate of charge/discharge has a large effect. As in all electrochemical devices, charge/discharge due to electrochemical reaction, and current density are related by Faraday’s Law. Larger currents result in shorter charge/discharge periods; however, as electric current increases, so does the overpotentials, which may favor secondary effects. These effects contribute to capacity loss in batteries during operation [
10
,
11
].
The goal of this paper is to formulate an optimization problem for finding the optimal operation schedule for a battery that also includes current-induced battery degradation. Other contributions have also considered battery degradation in the formulation of their optimization problems: Sarker et al. [
12
] showed that not taking into account battery degradation results in a solution that leads to an operating schedule that actually depletes the battery faster than the solution that is found when considering these effects directly in the optimization problem; Yan et al. [
13
] showed a similar effect but with a slightly different use: that of the battery being used as a frequency regulator; Hu et al. [
14
] considered the cost of battery degradation in energy management of plug-in hybrid electric vehicles.
Unlike a previous mixed integer linear problem (MILP) [
12
], in this paper a convex formulation is presented. The advantage of this formulation lies in the fact that global optimality is guaranteed, and also that with the same computing capabilities, problems considering longer time spans (not only a single day) can be solved. This in turn allows the estimation of the leftover capacity of the battery after a certain number of cycles. This is precisely the main novelty of this paper: the capability of predicting the effects that different pricing policies have in long-term optimal operation scheduling, when battery degradation is taken into account.
In all case studies Li-ion batteries, an energy storage device that presents an outstanding specific energy and power, long calendar and cycle lives, high efficiency and reliability [
15
], were considered. The paper is organized as follows: 
Section 2
 presents the basic optimization problem and its convex form; using this model, the optimal daily operation for two different pricing policies (simple and complex) are presented in 
Section 3
. An extension to the model in 
Section 2
 that captures the cumulative effect of battery usage is presented in 
Section 4.1
. 
Section 4.2
 and 
Section 4.3
 present the long-term optimal operation schedule for the same tariffs considered in 
Section 3
. Finally, the key points of the paper are summarized in 
Section 5
.
Throughout the paper we will consider a consumer who wants to install a Li-ion battery as a way to take advantage of a given pre-established TOU tariff policy. We will assume that the consumer has already chosen the capacity that needs to be installed and the general problem is how to optimally operate the battery so that savings in the electricity bill are larger than the costs induced by its use. Then, the objective function from the user point of view can be expressed as:








max


(




e


l


e


c


t


r


i


c


i


t


y


s


a


v


i


n


g


s


−


c


a


p


a


c


i


t


y


l


o


s


s




)










(1)




As shown in 
Figure 1
, when being charged, at a moment 
t
, the battery takes energy from the grid at charging power 




p




t




C




; when being discharged, at a later time 




t


′




, the battery feeds a load (for example a house) at discharging power 




p






t


′






D




. Besides, the energy that the battery receives from the grid and the energy the load receives from the battery are affected by efficiency factors denoted as 




η


+




 and 




η


−




 respectively. At times, it might be more convenient to by-pass the battery and feed the load directly from the grid. This is shown in 
Figure 1
 as the direct power flow 




p




t






d


i


r


e


c


t






.
Using these variables the savings in electricity can be expressed as:














electricity




savings


=


cost




of




energy




discharged




at




time






t


′




































−


cost




of




energy




charged




at




time




t
















(2)


















cost




of




energy




charged




at




time




t


=




$


t






p


t


C




Δ


t
















(3)


















cost




of




energy




discharged




at




time






t


′




=




$




t


′








p




t


′




D




Δ




t


′


















(4)





where 




$


t




 and 




$




t


′






 denote the price of the electricity at different times as given in the tariff policy.
On the other hand, the cost of capacity loss due to operation can be written as:














capacity




loss


=




C




E


S






B




C




E


S








x






t


″








C


L




















(5)





where 




C




E


S






 denotes the cost of the technology in USD/kWh; 




B




C




E


S








 is the installed capacity, a fixed parameter with units kWh; and 




x






t


″








C


L






 is the fraction of capacity lost during operation time 




t


″




. Note that 




t


″




 is a dummy variable: 






t


″




=


t




 during charge and 






t


″




=




t


′






 during discharge.
Then, for a given period of time 


τ


 divided into smaller time steps 




Δ


t




, with 




Δ


t




 equal to the minimum electricity pricing step, the objective function can be stated in canonical form as:








min


Δ


t




∑




t


=


1






t


=


τ








$


t






(




p




t




C




−




p




t




D




)




+




C




E


S






B




C




E


S








∑




t


=


1






t


=


τ








x




t






C


L














(6)




In Equation (6) the terms 




$


t




, 




C




E


S






, 




B




C




E


S








 are parameters, whereas the terms 




p




t




C




, 




p




t




D




 and 




x




t






C


L






 are decision variables of the problem. These variables are related to each other and to other decision variables through the following constraints:
The battery cannot charge and discharge at the same time
This restriction can be mathematically posted as











p




t




D






p




t




C




=


0










(7)




For safety reasons, there is a maximum power that should not be exceeded neither during charge (




p




C


−


M


A


X






) nor during discharge (




p




D


−


M


A


X






). Additionally, 




p




t




C




 and 




p




t




D




 will always be assumed as positive variables. Then:















0


≤




p




t




C




≤




p




C


−


M


A


X




















(8)


















0


≤




p




t




D




≤




p




D


−


M


A


X




















(9)




Energy balance: the state of charge at a certain time, 




s


o




c


t






, depends on the state of charge at the immediately previous period of time 




s


o




c




t


−


1








 and the amount of energy that is effectively used in electrochemical reactions during charge or discharge processes:









s


o




c


t




=


s


o




c




t


−


1






+


Δ


t




p




t




C






η


+




−


Δ


t




p




t




D




/




η


−












(10)





where the efficiencies 


η


 are as defined previously (see 
Figure 1
).
In order to preserve the battery life, the state of charge should neither be lower than a minimum fixed value (




S


O




C




M


I


N








) nor larger than a maximum (




S


O




C




M


A


X








). Both these parameters correspond to different fractions of the total available capacity.









S


O




C




M


I


N






≤


s


o




c


t




≤


S


O




C




M


A


X














(11)




Equations for battery degradation:
Battery degradation kinetics are studied in the electrochemistry field by using a parameter known as the 




C




r


a


t


e






 [
16
,
17
]. The 




C




r


a


t


e






 is the inverse of the characteristic time that relates electric current during a time step, 




I


t




 in units of A or mA, and the electrical charge capacity of the battery, 




B




C




Q






E


S








 in units of Ah or mAh.











C




r


a


t


e


,


t






=






I


t






B




C




Q






E


S


















(12)




This coefficient allows a size-independent study of the kinetics of any reaction happening in batteries. The fraction of capacity lost by the battery 




x


t




C


L






 can then be expressed as a function of the 




C




r


a


t


e






.











x




t






C


L






=


f




(




C




r


a


t


e


,


t






)












(13)





where the functionality 
f
 is obtained experimentally by running charge/discharge cycles at different currents, and is usually a non-linear expression. Taking as a basis the experimental data reproduced in 
Figure S1
, it can be seen that 




f


(




C




r


a


t


e


,


t






)




 can be modeled as a convex second order polynomial.











x




t






C


L






=




α


1










C




r


a


t


e


,


t








2




+




α


2






C




r


a


t


e


,


t














(14)





with 




α


1




 and 




α


2




 parameters that are adjusted to the experimental data.
To relate the 




C




r


a


t


e






 from its definition (Equation (12)) with the variables used in this problem, a nearly constant working potential of the cell needs to be assumed. In practice, this assumption implies disregarding the effects of the overpotentials in the potential vs. current 
(
E
-
I
)
 curve. Then, 






E


t




=




E


t


0






 and:

















C




r


a


t


e


,


t






=








I


t






E


t








B




C




Q






E


S








E


t


0






















C




r


a


t


e


,


t






=






p


t






B




C




E


S
























(15)




Notice that as charge and discharge do not happen simultaneously (see Equations (7) and (15)) can be rewritten to combine both processes in a single equation:











C




r


a


t


e


,


t






=








p




t




C




+




p




t




D








B




C




E


S


















(16)




At this point, it is worth commenting that natural aging phenomena (just a function of time) has not been considered here as calendar aging is not dependent on the rate of battery use.
The battery cannot charge and discharge at the same time
This restriction can be mathematically posted as











p




t




D






p




t




C




=


0










(7)




For safety reasons, there is a maximum power that should not be exceeded neither during charge (




p




C


−


M


A


X






) nor during discharge (




p




D


−


M


A


X






). Additionally, 




p




t




C




 and 




p




t




D




 will always be assumed as positive variables. Then:















0


≤




p




t




C




≤




p




C


−


M


A


X




















(8)


















0


≤




p




t




D




≤




p




D


−


M


A


X




















(9)




Energy balance: the state of charge at a certain time, 




s


o




c


t






, depends on the state of charge at the immediately previous period of time 




s


o




c




t


−


1








 and the amount of energy that is effectively used in electrochemical reactions during charge or discharge processes:









s


o




c


t




=


s


o




c




t


−


1






+


Δ


t




p




t




C






η


+




−


Δ


t




p




t




D




/




η


−












(10)





where the efficiencies 


η


 are as defined previously (see 
Figure 1
).
In order to preserve the battery life, the state of charge should neither be lower than a minimum fixed value (




S


O




C




M


I


N








) nor larger than a maximum (




S


O




C




M


A


X








). Both these parameters correspond to different fractions of the total available capacity.









S


O




C




M


I


N






≤


s


o




c


t




≤


S


O




C




M


A


X














(11)




Equations for battery degradation:
Battery degradation kinetics are studied in the electrochemistry field by using a parameter known as the 




C




r


a


t


e






 [
16
,
17
]. The 




C




r


a


t


e






 is the inverse of the characteristic time that relates electric current during a time step, 




I


t




 in units of A or mA, and the electrical charge capacity of the battery, 




B




C




Q






E


S








 in units of Ah or mAh.











C




r


a


t


e


,


t






=






I


t






B




C




Q






E


S


















(12)




This coefficient allows a size-independent study of the kinetics of any reaction happening in batteries. The fraction of capacity lost by the battery 




x


t




C


L






 can then be expressed as a function of the 




C




r


a


t


e






.











x




t






C


L






=


f




(




C




r


a


t


e


,


t






)












(13)





where the functionality 
f
 is obtained experimentally by running charge/discharge cycles at different currents, and is usually a non-linear expression. Taking as a basis the experimental data reproduced in 
Figure S1
, it can be seen that 




f


(




C




r


a


t


e


,


t






)




 can be modeled as a convex second order polynomial.











x




t






C


L






=




α


1










C




r


a


t


e


,


t








2




+




α


2






C




r


a


t


e


,


t














(14)





with 




α


1




 and 




α


2




 parameters that are adjusted to the experimental data.
To relate the 




C




r


a


t


e






 from its definition (Equation (12)) with the variables used in this problem, a nearly constant working potential of the cell needs to be assumed. In practice, this assumption implies disregarding the effects of the overpotentials in the potential vs. current 
(
E
-
I
)
 curve. Then, 






E


t




=




E


t


0






 and:

















C




r


a


t


e


,


t






=








I


t






E


t








B




C




Q






E


S








E


t


0






















C




r


a


t


e


,


t






=






p


t






B




C




E


S
























(15)




Notice that as charge and discharge do not happen simultaneously (see Equations (7) and (15)) can be rewritten to combine both processes in a single equation:











C




r


a


t


e


,


t






=








p




t




C




+




p




t




D








B




C




E


S


















(16)




At this point, it is worth commenting that natural aging phenomena (just a function of time) has not been considered here as calendar aging is not dependent on the rate of battery use.
Therefore, given the objective function (Equation (6)) and the restrictions (7)–(11), (14), (16) the problem is a non-linear programming (NLP) problem where the decision variables are 




p




t




C




,




p




t




D




,




s


o




c


t






,




x




t






C


L






 and 




C




r


a


t


e


,


t






. As stated, the problem has two non-linear equality constraints (Equations (7) and (14)) thus it is non-convex. Relaxations, that result in an equivalent convex problem are discussed in the following section.
Equation (7) is the equation that states that simultaneous charge and discharge processes are not possible. Besides the product-based formulation used here, a formulation employing a binary variable that multiplies either 




p




t




D




 or 




p




t




C




 has been reported in Jabr et al. [
18
]. However, this approach leads to a mixed integer problem (MILP or MINLP) which does not solve the fundamental convexity problem.
In this work we will make use of a result in Castillo and Gayme [
19
].
“For energy storage capacity at bus 




n


∈


N




 where (the energy storage capacity) 






C


n




>


0




, if (the locational marginal price) 






λ


n






(


t


)






 is strictly positive then (...) simultaneous charging and discharging will not occur”.
This result was obtained in the context of optimal allocation and operation of a distributed energy storage system, in a network of generators, storage devices and consumers, where the price of the energy was not included as a parameter of the model, instead it was estimated through the dual variable 






λ


n






(


t


)






 which is referred in the paper as a market-based price signal.
Despite our overall problem formulation is different, from the energy storage device, i.e., the battery, the situation is similar as in both cases the energy storage device consumes from an upstream energy provider and supplies to a downstream load. In our case the electricity prices are given and correspond to the TOU tariffs which are always positive. Then, it is reasonable to assume that the result from Castillo and Gayme [
19
] will also be valid here, and 




p




t




D




 and 




p




t




C




 will not be non-zero at the same time. At a more fundamental level, the explanation is that as charge/discharge efficiencies are always lower than 1, simultaneous charge and discharge just dissipates energy. Hence a portion of the energy consumed does not result in an effective change in the state of charge of the energy storage device, an effect that is usually not sought.
Therefore, based on the above discussion, Equation (7) will be excluded from the formulation of the problem; upon finding the optimal solution in different case studies a check will be performed in order to assess the validity of the relaxation.
Equation (13) is the equation relating the fraction of capacity lost by the battery for different 




C




r


a


t


e


s






. As discussed previously, this equation is derived by fitting experimental data and results in a convex expression as the parameter 




α


1




 is positive. As in Equation (6) the variable 




x




t






C


L






 is multiplied by positive values, an increase in the value of 




x




t






C


L






 will directly imply an increase in the objective function. Hence, if the equality constraint in Equation (13) is relaxed to the convex inequality constraint in Equation (17):










x




t






C


L






≥




α


1










C




r


a


t


e


,


t








2




+




α


2






C




r


a


t


e


,


t














(17)





minimization of the objective function will always result in an active constraint, thus the same optimal solution.
At this point it should be noted that although we started from a particular case (experimental data for Samsung INR 18650 reported in Sarker et al. [
12
]) it has been experimentally observed that other types of batteries also present a convex functionality between the capacity leftover in the battery after a certain number of charge/discharge cycles (




B


C




) and the 




C




r


a


t


e






 [
20
]. Thus, the relaxation presented here can be generalized if other batteries, with other convex functionalities, are considered. Despite the details are not yet clearly understood, the convex functionality is to be expected as increasing the current increases the overpotentials. Thus both, the number of undesired events (physical or chemical) and the rate at which these events happen increase creating a snowball effect in terms of battery degradation [
11
,
21
,
22
].
Following the discussion in the previous section, we present here the canonical form of the convex NLP problem which is equivalent to the one discussed in 
Section 2.2
.















min






p




t




C




,




p




t




D




,


s


o




c


t




,




x




t






C


L






,




C




r


a


t


e


,


t
















Δ


t




∑




t


∈


τ








$


t






(




p




t




C




−




p




t




D




)




+




C




E


S






B




C




E


S








∑




t


∈


τ








x




t






C


L




















(18)


















s


.


t


.












s


o




c


t




=


s


o




c




t


−


1






+


Δ


t




p




t




C






η


+




−


Δ


t




p




t




D




/




η


−


















(19)




















C




r


a


t


e


,


t






=








p




t




C




+




p




t




D








B




C




E


S
























(20)




















x




t






C


L






≥




α


1








(




C




r


a


t


e


,


t






)




2




+




α


2






C




r


a


t


e


,


t




















(21)


















S


O




C




M


I


N






≤


s


o




c


t




≤


S


O




C




M


A


X




















(22)


















0


≤




p




t




C




≤




p




C


−


M


A


X




















(23)


















0


≤




p




t




D




≤




p




D


−


M


A


X




















(24)




The problem is implemented in GAMS 24.8.5 and solved with IPOPT [
23
].
In this section, the optimal charge/discharge schedules for different tariff policies are presented. The simulations were run considering an example of each of the two most extreme TOU pricing policies:
The “simple tariff” refers to a pricing policy that only has two price steps: cheap (off-peak) and expensive (on-peak), and the daily price pattern is repeated throughout the year. Therefore, there are always some consecutive hours with exactly the same price. 
The “complex tariff” refers to a pricing policy where there are several price steps during a single day (the price is still constant for each hour of the day), different days present different prices (weekdays are priced differently than weekends and holidays and there is also seasonal variation), and prices are dependent on the expected weather.
The “simple tariff” refers to a pricing policy that only has two price steps: cheap (off-peak) and expensive (on-peak), and the daily price pattern is repeated throughout the year. Therefore, there are always some consecutive hours with exactly the same price. 
The “complex tariff” refers to a pricing policy where there are several price steps during a single day (the price is still constant for each hour of the day), different days present different prices (weekdays are priced differently than weekends and holidays and there is also seasonal variation), and prices are dependent on the expected weather.
An example of a “simple tariff” is given by the Uruguayan residential “UTE-Tarifa Inteligente” (smart rate) which consists of an 18 h period at a cheap rate, and a 6 h period at an expensive rate [
24
]. An example of a “complex tariff” is given by the Californian Southern California Edison tariff [
25
]. For medium consumers, this tariff classifies days into nine groups according to: High and Low cost Weekend; Extremely Hot, Very Hot, Hot, Moderate and Mild Summer Weekday, High and Low cost Winter Weekday. Both for winter and weekends classes, “High cost” and “Low cost” depend on the expected temperature.
Other TOU tariffs are in between the previous two extremes. For example the Brazilian “Tarifa Branca” [
26
], is a three-step simple tariff with the: cheap-medium priced-expensive-medium priced-cheap pattern on weekdays and cheap pattern on weekends. Another example is Iowa’s residential hourly pricing option [
27
] which is a two-step tariff which also differentiates between winter and summer.
In all cases, the maximum 




C




r


a


t


e






 is assumed to be 3; then maximum power and capacity ratio are related as 






p




C


−


M


A


X






=




p




D


−


M


A


X






=


3


B




C




E


S








. Upper and lower bounds for the state of charge (




S


O




C




M


A


X






,


S


O




C




M


I


N








) are assumed to be 80% and 20% of the installed capacity respectively. Both 




η


+




 and 




η


−




 are assumed to be 0.95 and installed capacity 




B




C




E


S








 is set at 10 kWh. Furthermore, we will assume that the battery is initially discharged (i.e., 




s


o




c


0




=


S


O




C




M


I


N








). The coefficients for the battery degradation equation are 




α


1




 = 1.06 × 10
−5
 and 




α


2




 = 1.44 × 10
−4
 (see 
S1 in Supplementary Information
). Estimated 2018 battery prices range from 580–750 USD/kWh for commercial and residential use [
28
]. However, as Li-ion battery systems still have margin to lower their production costs [
29
], battery prices used in the simulations were selected case by case to show key features of each case study.
Figure 2
a shows the TOU tariff used in Uruguay: electricity is cheap between 0:00 a.m.–5:00 p.m., significantly more expensive between 5:00–11:00 p.m., and cheap again during the last hour of the day (11:00 p.m.–0:00 a.m.). Note that in 
Figure 2
a we have redefined the time vector so that all low prices are together. In practice, this change means that a “storage day” starts at 11:00 p.m., and allows the one-day simulation to exploit the whole off-peak price period.
The optimal results for 




p




t




C




, 




p




t




D




, 




s


o




c


t






 and 




x




t






C


L






 for three different battery prices (




C




E


S






) are shown in 
Figure 2
b–d.
Notice that for a battery price of 500 USD/kWh the optimal solution neither takes power from the network nor supplies power to the load, and the battery 




S


O


C




 remains constant at the initial level. The reason is that in this case, the economical penalty for degrading the battery is larger than the savings for taking advantage of the TOU tariff, thus the battery should not be installed.
For battery prices of 300 and 400 USD/kWh, the optimal strategy is to slowly charge the battery during the whole low-price period at a steady rate, and then discharge it as slowly as possible during the high price period. This strategy results in low 




C




r


a


t


e


s






 for both charge and discharge thus low degradation factors 




x




t






C


L






. The strategy itself is the same for both battery prices, then total savings in the energy bill are the same (0.86 USD/d). However, as the penalty due to loss of battery capacity depends on initial battery price, overall savings are different and lower than bill savings: 0.34 USD/d and 0.17 USD/d for the 300 USD/kWh and 400 USD/kWh respectively.




p




t




C




 and 




p




t




D




 are never simultaneously non-zero and, as shown in 
Supplementary Materials
, the value of the Kuhn-Tucker multipliers verifies that Equation (21) is always active. Thus, the assumptions made for convexification of the problem are checked.
Figure 3
 shows the TOU tariff used by Southern California Edison Company (TOU-GS-2-RTP); days presenting a large variation in the tariff are shown in 
Figure 3
a, whereas days with moderate variations are shown in 
Figure 3
b.
In this case there are in principle 9 different optimal strategies each corresponding to a different day-type as discussed at the beginning of the section. However, from these nine price schedules, only four result in a non-trivial operation for batteries that cost 300 USD/kWh. The four price schedules that result in non-trivial operation coincide with the ones that have the largest variation between the maximum and the minimum electricity prices (i.e., 
Figure 3
a). 
Figure 4
 shows the optimal charge/discharge schedule for battery prices of 250, 300 and 400 USD/kWh. As the battery price decreases, moderate-priced days start also to show non-trivial operation, see as an example 
Figure S4
.
Compared to the first case study the most noticeable difference is that charge and discharge are now concentrated and not distributed during the day. For example, for Extremely Hot Summer Days (EHSD) charge is concentrated in two hours (3:00–5:00 a.m.) and discharge is concentrated between 3:00–5:00 p.m. (see 
Figure 4
a). Notice also that unlike the “simple” tariff the rate of charge/discharge varies. This effect is seen in 
Figure 4
a in the EHSD case: between 3:00–4:00 a.m. the battery consumes more power than between 4:00–5:00 a.m. Logically this is related to the price of the energy during those hours. In absolute terms, for the days that operation is allowed, this “complex” tariff results in a faster degradation of the battery than the “simple” tariff considered before. Figures with degradation rates are in the 
Supplementary Information (S3)
.
The difference in pricing also allows for some days to have a double charge/discharge cycle. For example, for a Very Hot Summer Day (VHSD) the first charge is between 2:00–5:00 a.m., the first discharge is between 3:00–4:00 p.m., the second charge is between 7:00–8:00 p.m. and the second discharge is between 8:00–9:00 p.m. This double cycle is allowed by the relatively large difference between the prices corresponding to the 7:00–8:00 p.m. and 8:00–9:00 p.m. interval.
Another salient feature of the complex tariff is that a difference in the cost of the battery affects the optimal operation: although the time of the day at which charge/discharge occurs is the same, the amount charged within each interval is different.
As in the previous case, all assumptions for problem relaxation were satisfied.
In the previous sections we showed how the optimal operation schedule was affected by the TOU tariff and the cost of the storage system itself. In this section, we expand those results to a more realistic setting in which the battery is going to be used during several years. As longer optimization periods are considered, charge and discharge cycles may result in a significant loss of capacity, and the problem presented in 
Section 2.3.3
 needs to be modified in order to allow for a daily change in the capacity of the battery. In other words, capacity is now a variable which will be represented by 




B




C


t






.
Without loss of generality we will consider daily changes in 




B




C


t






 (i.e., 




B




C


t




≡


B




C


d






) and not hourly changes, a consideration that is supported by the small hourly values obtained for 




x




t






C


L






 in 
Section 3
. However, as the tariffs still vary on an hourly basis, two time scales need to be considered: day and hour. As a result the variables in the previous sections will now be represented using both time scales (




p




d


,


h




C




, 




p




d


,


h




D




, 




s


o




c




d


,


h








, 




x




d


,


h






C


L






).
As 




B




C


d






 changes daily so do the allowed upper and lower bounds of the state of charge. Then, 




S


O




C




M


I


N






≡


S


O




C


d




M


I


N








 and 




S


O




C




M


A


X






≡


S


O




C


d




M


A


X








. If we still keep the same criteria (state of charge between 20% and 80% of the remaining capacity), then Equation (22) should be replaced by Equation (25):








0.2


B




C


d




≤


s


o




c




d


,


h






≤


0.8


B




C


d












(25)




Also, as 




B




C


d






 changes, the maximum power at which the battery can be charged or discharged safely, varies. Keeping the same 




C




r


a


t


e






 limit as in 
Section 3
 (






C




r


a


t


e






l


i


m


i


t






=


3




) then Equations (26) and (27), substitute Equations (23) and (24).









0


≤




p




d


,


h




C




≤


3






B




C


d








Δ


t














(26)












0


≤




p




d


,


h




D




≤


3






B




C


d








Δ


t














(27)




Complex tariff systems that present large differences between the highest and the lowest prices may provide an optimal schedule in which the battery charges months before it discharges. This strategy, even when acceptable, it is not practical as:
If energy is stored in batteries for a long period of time, self-discharge processes occur. For the sake of simplicity our model has not included these types of processes under the assumption that the charge and discharge cycle of the battery happens in a reasonably short period, most probably during the same day.
Complex tariffs depend on weather conditions and thus a reliable forecast. In this work we have assumed that reasonable forecasts are given for periods no longer than a week.
If energy is stored in batteries for a long period of time, self-discharge processes occur. For the sake of simplicity our model has not included these types of processes under the assumption that the charge and discharge cycle of the battery happens in a reasonably short period, most probably during the same day.
Complex tariffs depend on weather conditions and thus a reliable forecast. In this work we have assumed that reasonable forecasts are given for periods no longer than a week.
Then, to restrict the length between charge and discharge periods, Equation (28) was included as an extra restriction to the long-term optimization problem:










η


+






p




d


,


h




C




≤




1




η


−








(




∑






h


′




=


h




24






p




d


,




h


′






D




+




∑






d


′




=


d


+


1






d


+




d




l


i


m


i


t












∑






h


′




=


1




24






p






d


′




,




h


′






D




)












(28)




As written, Equation (28) indicates that the net power consumed by the battery at a certain time must be lower than the sum of the power supplied from the battery to the load during the following week (






d




l


i


m


i


t






=


7




). Depending on the technology used, this restriction could be tightened by using a smaller 




d




l


i


m


i


t






.
Figure 5
a shows the charge/discharge strategy (




p




d


,


h




C




 and 




p




d


,


h




D




) for the battery for the first and last days of use. As the tariff has two steps and remains constant for all days, the operation policy is the same as in the one-day case: slowly charge and discharge. The difference between the first and last day is the rate at which power is consumed/supplied, which diminishes with time due to battery degradation.
The capacity remaining in the battery at each time is shown in 
Figure 5
b. As seen after 10 years the battery still retains 53% of its original capacity.
As in the case discussed in 
Section 3.1
, for a non-trivial optimal, the price of the battery affects the value of the objective function, but not the value of the variables 




p




d


,


h




C




, 




p




d


,


h




D




, 




s


o




c




d


,


h








, 




x




d


,


h






C


L






. 
Table 1
 shows the yearly savings in electricity bills for capital costs below 400 USD/kWh (i.e., a price that guarantees a non-trivial solution). The net savings considering battery degradation over the operation period are 922 USD and 453 USD, for the 300 USD/kWh battery and 400 USD/kWh battery, respectively. The net present values calculated as:








N


P


V


=


−




C




E


S






·


B




C




E


S






+




∑




i


=


1




n










∑




d


∈


n








∑




h


=


1




24






$




d


,


h








(




p




d


,


h




C




−




p




d


,


h




D




)










(


1


+


r


)




i














(29)





are presented in 
Table 2
 for different battery prices and rates (
r
). Roughly, prices below 140 USD/kWh are required for batteries to be economically viable. This value is in agreement with the 125 USD/kWh target established by the DOE for battery prices for electric vehicles [
7
].
Figure 6
 shows the maximum temperatures recorded in Los Angeles, CA, during each day of 2017 [
30
]. As mentioned earlier, maximum temperature is the key parameter to establish the electricity price in the example of complex tariff used in this paper. The temperatures themselves are represented with bullets, whereas the colored blocks represent the tariff that would be applied for each day according to season and temperature effects (for clarity values for weekends were omitted in the graph). The full line in the graph represents the historical average for maximum temperature. Note that using averages is not suitable for running the simulations as no day would be classified in the extreme temperatures, which, as discussed in 
Section 3.2
, are precisely the days that provide a non-trivial optimal solution. For this reason, all simulations in this part of the paper where run assuming the temperatures recorded in 2017.
The optimal operation for the battery under the previous assumptions and an assumed battery price of 300 USD/kWh, is shown in 
Figure 7
. As expected, the strategy is to use the energy stored in the battery during the days where the temperature falls in the blue, yellow, orange and red zones indicated in 
Figure 6
, and these are not weekends. This strategy is appreciated in the “Daily discharge energy” subplot, where the total amount of power supplied by the battery to the load during a day (






∑




h


=


1






h


=


24








p




d


,


h




D






) is shown. To allow this operation, the battery initiates its charge in the previous days, in some cases distributing it within several days. This effect is clearly seen around day 175 and the stair-like progression in the SOC subplot, and is affected by the value assumed for 




d




l


i


m


i


t






 in Equation (28). The extreme case where 




d




l


i


m


i


t






 is unbounded is discussed in the 
Supplementary Information (S4.1)
, and justifies including Equation (28) in the set of restrictions.
An interesting feature is that the battery is not used in every viable day. Instead, battery usage is concentrated towards the end of the simulation time-frame as shown in 
Figure 8
. We interpret this result as a strategy to preserve battery life, a behavior consistent with the fact that the profit from using the battery at each time depends on its leftover capacity. The rationale is as follows: each day that the battery is used implies a loss in battery capacity that diminishes future profits. Days that provide a high profit are clearly always active. However, days that provide a low profit, become active only when the effect of capacity loss over the profit of future active days is counterbalanced by the (low) profit obtained by using the battery at the present day. This condition is more difficult to achieve at the beginning of the simulation, thus low profit days become active only at the end of the simulation time-frame when there are no more possible high profit future days. This effect is verified by running simulations with different simulation time-frames and costs. As expected, as the batteries become more economical, more moderate-priced days become active at earlier times in the simulation, and as the simulation time-frame diminishes, the active days plots become denser. For the interested reader, these plots are shown in 
Supplementary Materials
. At this point, it has to be noticed that despite being logical, a formal proof of strict convexity of the problem is required to guarantee the uniqueness of the strategy discussed in here.
The net savings considering battery degradation over the operation period are 1006, 977 and 953 USD for 200, 250 and 300 USD/kWh battery costs respectively. Compared to 
Section 4.2
, the difference is not only due to the difference in 




C




E


S






, but also in the operation scheduling (




p




d


,


h




C




 and 




p




d


,


h




D




) and so in battery degradation (




x




d


,


h






C


L






). 
Table 3
 shows the yearly savings in electricity bills and the annual loss of capacity for different capital costs. Note that electricity savings are similar for each battery cost, because the extra days that the battery is active add little savings.
With the advent of renewable energies, inclusion of batteries as self-storage devices provides an intermediate solution between demand response and grid-level energy storage. In order for this strategy to be widely adopted by small and medium size consumers, a balance between the savings in electricity bills and the cost of replacing the battery must be achieved. In this paper, a new model for optimal battery operation, that includes induced capacity loss due to charge/discharge processes, and its accumulation over time, was developed.
The original problem was relaxed to a convex problem that guarantees global optimality and allows for running the simulations over long time-frames. All the assumptions made in order to relax the original to a convex problem were checked, and are valid as long as battery efficiencies can be considered constant.
The model developed in here allows studying the convenience or not of the installation of a battery-based energy storage system in a residential or small-scale business setting. The model was used to predict the behavior of a Li-ion battery under the assumption of a simple two-price-step day-invariant TOU pricing policy, and a complex temperature-day-season dependent one.
The results of our simulations suggest that simple tariffs, where the price is constant for a large range of hours, operate so that service life is preserved. This preservation is accomplished by charging and discharging every day at very low rates. Our simulations also show that there is a turning point in the cost of the battery that makes the operation not worth. This is, the savings in electricity bill do not compensate the penalization due to capacity loss. This effect is seen even when running the one-day problem, and may be regarded as a first indicator of whether or not it is reasonable to install a battery. For the prices considered in this paper, this turning point is in between 400–500 USD/kWh. Nevertheless, having a battery cost below the turning point does not imply that installing a battery is profitable: positive 




N


P


V




 values for a 10-year lifespan, usual discount rates, and the assumptions made in this case study, are obtained only if the battery price falls below 140 USD/kWh.
For the case of complex tariffs our simulations show that for the same battery price, savings achieved in some individual days could be higher than those of the simple case. However, these savings are counterbalanced with the fact that the battery is not used on a regular (daily) basis. Overall, the battery for the complex tariff considered here is used at most 90 days of the year. Another feature of relevance when considering complex tariffs is that limiting the desired time span between charge and discharge becomes an important input parameter of the optimization problem.
Overall the conclusion is that current Li-ion battery prices (in the order of 500 USD/kWh) and TOU pricing policies are still not attractive enough for acquisition by residential/small-scale consumers. However, as Li-ion batteries systems still have margin to lower their production costs and battery prices are expected to decrease in the near future, small variations in tariff policies may make a difference to favor the installation of this energy storage solutions.
Available online at 
https://www.mdpi.com/2227-9717/6/10/204/s1
.
A.I.T. is the PhD Advisor of M.C. Problem conceptualization, methodology, and formal analysis were developed by discussions between the two authors. M.C. developed the code and run the simulations under the supervision of A.I.T. Both authors contributed equally to the analysis of the results, writing and editing the manuscript.
This research received funding from Universidad de la República (UdelaR)–Montevideo, Uruguay.
Mariana Corengia and Ana I. Torres gratefully acknowledge the 
Comisión Sectorial de Investigación Científica
–UdelaR for the incentive “Dedicación Total” and several travel grants. Ana I. Torres gratefully acknowledges the 
Sistema Nacional de Investigadores
 for the economic incentive. Both authors would like to express their appreciation to Juan Andrés Bazerque, Instituto de Ingeniería Eléctrica, UdelaR, for bringing to their attention publications that enriched this work.
The authors declare no conflict of interest.
The following abbreviations are used in this manuscript:



τ


optimization total period of time




η


+




battery charging efficiency




η


−




battery discharging efficiency




Δ


t




time step




B




C




E


S








energy storage installed capacity (energy units)




B




C




Q






E


S








initial energy storage installed capacity (electrical charge units)




B




C


t






energy storage capacity at 
t
 (energy units)




C




r


a


t


e






dimensionless charge/discharge rate




C




E


S






market cost of battery capacity




E


t




terminal potential difference at time 
t




E


t


0




open circuit potential difference at time 
t




I


t




net current at time 
t




p




C


−


M


A


X






maximum safe charging power




p




t




C




charge power at time 
t




p




D


−


M


A


X






maximum safe discharging power




p




t




D




discharge power at time 
t
r
discount rate




s


o




c


t






state of charge at time 
t




S


O




C




M


I


N








Minimum required state of charge




S


O




C




M


A


X








Maximum allowed state of charge




x




t






C


L






fraction of capacity loss during the time step at 
t




$


t




Energy grid price at time 
t